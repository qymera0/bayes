######################################################################################
# This program creates a function to generate and print the results for various     ##
# defibrillation efficacy estimates for a new study with 300 pts for design-B       ##
# devices.                                                                          ##
# Inputs: MCMC samples generated by the Bayesian analysis for the following model   ##
# parameters:                                                                       ##
# Number of patients in the design-A and design-B studies combined -N               ##
# Number of patients in the Design-B feasibility study - N1                         ##
# Number of MCMC samples - ngibbs                                                   ##
# Number of patients in the new design-B clinical study - N_New                     ##
# MCMC sample for the slope parameter - G                                           ##
# MCMC samples for the E50 parameter - Theta                                        ##
# MCMC samples for the scale and shrinkage parameters - Delta, Kappa                ##
######################################################################################

# Define a function to print design-B device Defib Efficacy estimation Results for a 
# new clinical study of a specified size

PrintDesBReslts <- function(ngibbs,N1,N1_s,N_New,G,Theta,delta,kappa) {
  
  # Initialize the matrix Theta1 to store E50 values for design-B devices
  Theta0 <- array(0,dim=c(ngibbs,N_New))
  Theta1 <- array(0,dim=c(ngibbs,N_New))
  # Generate a sample of size N_New from the posterior distributions of E50 values.  
  # There are N E50 values to choose from for this sample for each of the ngibbs MCMC   
  # samples.The sampling is done with replacement
  for (i in 1:ngibbs) {Theta0[i,] <- sample(Theta[i,],size=N_New,replace=TRUE)}
  Id1 <- rep(1,N_New)
  #dim(Theta1)
  for (i in 1:ngibbs){
    Theta1[i,] = (Theta0[i,])^((delta[i])^Id1)*(1-kappa[i]*Id1) 
    } 
  
  ## Initialize the matrices to store estimated defib efficacy probabilities using
  ## MCMC samples
  p30 <- matrix(0,nrow=ngibbs,ncol=N_New)
  p35 <- matrix(0,nrow=ngibbs,ncol=N_New)
  p40 <- matrix(0,nrow=ngibbs,ncol=N_New)
  # Initialize the matrices to hold binomial counts data
  ImpS_30J <- matrix(0,nrow=ngibbs,ncol=N_New)
  S40 <- matrix(0,nrow=ngibbs,ncol=N_New)
  # Initialize vectors to store various defibrillation efficacy probabilities.  
  # This stored data is used to compute 95% credible intervals for the estimated 
  # defib efficacies.
  ProbS_30J <- numeric(ngibbs)  
  ProbS_35J <- numeric(ngibbs)    
  ProbS_40J <- numeric(ngibbs)   
  ProbSS_30J <- numeric(ngibbs) 
  ProbSS_35J <- numeric(ngibbs)   
  ProbSS_40J <- numeric(ngibbs) 

  ProbImpS_30J <- numeric(ngibbs)
  ProbImpf_30J <- numeric(ngibbs)
  PrS40givenImpS30 <- numeric(ngibbs)  
  
  for(i in 1:ngibbs){
    # OBTAIN PROBABILITY OF SUCCESSFUL SHOCK
    
    p40[i,] <- 1/(1+(Theta1[i,]/40)^G[i])
    p35[i,] <- 1/(1+(Theta1[i,]/35)^G[i])
    p30[i,] <- 1/(1+(Theta1[i,]/30)^G[i]) 
    # For each MCMC sample, store the average (based on selected number of pts) defib
    # efficacy at each different energy level
    ProbS_30J[i] <- mean(p30[i,]) # Avg. Prob. of 1st shock success at 30J
    ProbS_35J[i] <- mean(p35[i,]) # Avg. Prob. of 1st shock success at 35J
    ProbS_40J[i] <- mean(p40[i,]) # Avg. Prob. of 1st shock success at 40J 

    ProbSS_30J[i] <- mean((p30[i,])^2) # Avg. Prob. of 1st & 2nd shock success at 30J
    ProbSS_35J[i] <- mean((p35[i,])^2) # Avg. Prob. of 1st & 2nd shock success at 35J   
    ProbSS_40J[i] <- mean((p40[i,])^2) # Avg. Prob. of 1st & 2nd shock success at 40J   
    # Compute the average probability of implant success (2S in a row out of 4 shocks)
    # at 30J for each MCMC sample
    ProbImpS_30J[i] <- mean(ProbSS_30J[i] #SS
                            + p30[i,]*(1-p30[i,])*(p30[i,])^2  #SFSS
                            + (1-p30[i,])*(p30[i,])^2  #FSS
                            + (1-p30[i,])^2*(p30[i,])^2) #FFSS
    ProbImpf_30J[i] <- 1-ProbImpS_30J[i]
    
    # It is not possible to directly compute the conditional probability of success at
    # 40J given implant success at 30J because the success probabilities within 
    # patients have unknown correlations. So, we use the following Binomial counts
    # data to compute the conditional probability
    
    #Generate success/fail counts for 1 - 4 shocked episodes at different energies
    
    Shk1_30 <- rbinom(n=N_New,size=1,prob=p30[i,])
    Shk2_30 <- rbinom(n=N_New,size=1,prob=p30[i,])
    Shk3_30 <- rbinom(n=N_New,size=1,prob=p30[i,])
    Shk4_30 <- rbinom(n=N_New,size=1,prob=p30[i,])
    Shk1_40 <- rbinom(n=N_New,size=1,prob=p40[i,])

    # Get counts of design-B device implant sucess (2S in a row out of 4 shocks) 
    # as follows
    ImpS_30J[i,] <- ifelse((((Shk1_30==1) & (Shk2_30 == 1)) | ((Shk1_30==0) 
                  & (Shk2_30 == 1) & (Shk3_30 == 1)) | ((Shk1_30==1) & (Shk2_30==0)
                  & (Shk3_30 == 1) & (Shk4_30 == 1)) | ((Shk1_30==0) & (Shk2_30==0) 
                  & (Shk3_30 == 1) & (Shk4_30 == 1))), 1,0) 
    S40[i,] = ifelse(Shk1_40==1,1,0)
   
    # Determine conditional probability of success at 40J given that implant success 
    # at 30J
    PrS40givenImpS30[i] <- mean(S40[i,][ImpS_30J[i,]==1],na.rm=TRUE)
    }
  
  ## Determine average probability of 1st shock success at various energy levels
  PrS_40 <- mean(p40)
  PrS_35 <- mean(p35)
  PrS_30 <- mean(p30)
  ## Determine average probability that both 1st and 2nd shocks are successful at 
  ## various energy levels
  PrSS_30 <- mean(p30^2); # S+S at 30J
  PrSS_35 <- mean(p35^2); # S+S at 35J
  PrSS_40 <- mean(p40^2); # S+S at 40J

  # Probability calculations for additional outcomes (besides PrSS_30) with implant 
  # success at 30J
  PrSfSS_30 <- mean(p30*(1-p30)*p30*p30) #S+F+S+S at 30J
  PrfSS_30 <- mean((1-p30)*p30^2) #F+S+S at 30J
  PrffSS_30 <- mean((1-p30)^2*p30^2) #F+F+S+S at 30J

  # Compute the probability of design-B device new clinical study implant success for 
  # 30J (10J safety margin with 40J max output device) shocks
  prImpSuc_30 <- PrSS_30 + PrSfSS_30 + PrfSS_30 + PrffSS_30 
  # Compute probabilities of design-B device new clinical study implant failure for
  # 30J shocks
  prImpfail_30 <- 1-prImpSuc_30
  ## Determine average conditionla probability of Success at 40J given 
  ## implant success at 30J 
 
  PrAvgS40givenImpS30 <- mean(PrS40givenImpS30,na.rm=TRUE)

  # Determine 95% Credible Intervals for various types of defibrillation efficacy estimates
  PrS95CI_30J <- quantile(ProbS_30J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                          type=7)
  PrS95CI_35J <- quantile(ProbS_35J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                          type=7)
  PrS95CI_40J <- quantile(ProbS_40J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                          type=7)  
  
  PrSS95CI_30J <- quantile(ProbSS_30J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                           type=7)  
  PrSS95CI_35J <- quantile(ProbSS_35J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                           type=7)    
  PrSS95CI_40J <- quantile(ProbSS_40J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                           type=7)    
  
  PrImpS95CI_30J <- quantile(ProbImpS_30J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                             type=7) 
  
  PrImpf95CI_30J <- quantile(ProbImpf_30J, probs=c(0.025,0.975),na.rm=FALSE, names=FALSE, 
                             type=7) 
  Pr95CI_S40givenImpS30 <- quantile(PrS40givenImpS30, probs=c(0.025,0.975),na.rm=FALSE,
                             names=FALSE, type=7) 
  
  
  cat(paste("PREDICTIONS for design-B device clinical study with",N_New," pts. based",
      "\non scalable model fitted to 325 design-A and",N1,"design-B patients' data\n"))
  print(c(
    sprintf("Predicted Probability 1st shock success at 30J: %.1f (95CI: %.1f - %.1f) –
    (model) Vs. %.1f (design-B feas.)",100*PrS_30, 100*PrS95CI_30J[1],
    100*PrS95CI_30J[2],100*(N1_s)/N1),
    sprintf("Predicted Probability of 1st shock success at 35J: %.1f (95CI: %.1f - %.1f)",
            100*PrS_35, 100*PrS95CI_35J[1], 100*PrS95CI_35J[2]),
    sprintf("Predicted Probability of 1st shock success at 40J: %.1f (95CI: %.1f - %.1f)",
            100*PrS_40, 100*PrS95CI_40J[1], 100*PrS95CI_40J[2]),
    sprintf("Predicted Probability of S + S (Success in 1st and 2nd shocks) at 30J: %.1f
    (95CI: %.1f - %.1f)", 100*PrSS_30, 100*PrSS95CI_30J[1], 100*PrSS95CI_30J[2]),
    sprintf("Predicted Probability of S + S (Success in 1st and 2nd shocks) at 35J: %.1f
    (95CI: %.1f - %.1f)",100*PrSS_35, 100*PrSS95CI_35J[1], 100*PrSS95CI_35J[2]),   
    sprintf("Predicted Probability of S + S (Success in 1st and 2nd shocks) at 40J: %.1f
    (95CI: %.1f - %.1f)",100*PrSS_40, 100*PrSS95CI_40J[1], 100*PrSS95CI_40J[2]),          
    sprintf("Predicted Probability of 2 of 4 implant success with 30J shocks: %.1f (95CI: 
    %.1f - %.1f)", 100*prImpSuc_30, 100*PrImpS95CI_30J[1], 100*PrImpS95CI_30J[2]),
    sprintf("Predicted Probability of failure to pass 2 of 4 implant criterion with 30J 
    Shocks: %.1f (95CI: %.1f - %.1f)", 100*prImpfail_30, 100*PrImpf95CI_30J[1],
    100*PrImpf95CI_30J[2]),
    sprintf("Predicted Probability of success at 40J given that 2 of 4 implant success
    with 30J shocks: %.1f (95CI: %.1f - %.1f)", 100*PrAvgS40givenImpS30,
    100*Pr95CI_S40givenImpS30[1], 100*Pr95CI_S40givenImpS30[2])
    ))       
}
